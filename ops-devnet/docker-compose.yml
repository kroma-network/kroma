version: '3.4'

# This Compose file is expected to be used with the devnet-up.sh script.
# The volumes below mount the configs generated by the script into each
# service.

volumes:
  l1_data:
  l2_data:
  kroma_log:


services:
  l1:
    pid: host # allow debugging
    image: ethereum/client-go:v1.13.4
    ports:
      - "8545:8545"
      - "8546:8546"
    environment:
      CHAIN_ID: 900
      GETH_MINER_RECOMMIT: 100ms
    volumes:
      - "l1_data:/db"
      - "${PWD}/entrypoint-l1.sh:/entrypoint.sh"
      - "${PWD}/../.devnet/genesis-l1.json:/genesis.json"
      - "${PWD}/test-jwt-secret.txt:/config/test-jwt-secret.txt"
    entrypoint:
      - "/bin/sh"
      - "/entrypoint.sh"

  l2:
    pid: host # allow debugging
    image: kromanetwork/geth:v0.4.0-dev
    ports:
      - "9545:8545"
      - "9546:8546"
    environment:
      CHAIN_ID: 901
      GETH_MINER_RECOMMIT: 100ms
    volumes:
      - "l2_data:/db"
      - "${PWD}/entrypoint-l2.sh:/entrypoint.sh"
      - "${PWD}/../.devnet/genesis-l2.json:/genesis.json"
      - "${PWD}/test-jwt-secret.txt:/config/test-jwt-secret.txt"
    entrypoint: # pass the L2 specific flags by overriding the entry-point and adding extra arguments
      - "/bin/sh"
      - "/entrypoint.sh"
      - "--authrpc.jwtsecret=/config/test-jwt-secret.txt"

  kroma-node:
    pid: host # allow debugging
    depends_on:
      - l1
      - l2
    image: "kromanetwork/node"
    build:
      context: ..
      target: "op-node"
    environment:
      NODE_L1_ETH_RPC: ws://l1:8546
      NODE_L2_ENGINE_RPC: http://l2:8551
      NODE_L2_ENGINE_AUTH: /config/test-jwt-secret.txt
      NODE_ROLLUP_CONFIG: /rollup.json
      NODE_RPC_ADDR: 0.0.0.0
      NODE_RPC_PORT: 8545
      NODE_RPC_ENABLE_ADMIN: true
      NODE_SNAPSHOT_LOG: /kroma_log/snapshot.log
      NODE_SEQUENCER_ENABLED: true
      NODE_SEQUENCER_L1_CONFS: 0
      NODE_VERIFIER_L1_CONFS: 0
      NODE_P2P_LISTEN_IP: 0.0.0.0
      NODE_P2P_LISTEN_TCP_PORT: 9003
      NODE_P2P_LISTEN_UDP_PORT: 9003
      NODE_P2P_PEER_SCORING: light
      NODE_P2P_PEER_BANNING: true
      NODE_P2P_PRIV_PATH: /config/p2p-node-key.txt
      NODE_P2P_SEQUENCER_KEY: 8b3a350cf5c34c9194ca85829a2df0ec3153be0318b5e2d3348e872092edffba
      NODE_METRICS_ENABLED: true
      NODE_METRICS_ADDR: 0.0.0.0
      NODE_METRICS_PORT: 7300
      NODE_PPROF_ENABLED: true
    ports:
      - "7545:8545"
      - "9003:9003"
      - "7300:7300"
      - "6060:6060"
    volumes:
      - "${PWD}/p2p-sequencer-key.txt:/config/p2p-sequencer-key.txt"
      - "${PWD}/p2p-node-key.txt:/config/p2p-node-key.txt"
      - "${PWD}/test-jwt-secret.txt:/config/test-jwt-secret.txt"
      - "${PWD}/../.devnet/rollup.json:/rollup.json"
      - kroma_log:/kroma_log

  kroma-validator:
    pid: host # allow debugging
    depends_on:
      - l1
      - l2
      - kroma-node
    image: "kromanetwork/validator"
    build:
      context: ..
      target: "kroma-validator"
    ports:
      - "6062:6060"
      - "7302:7300"
      - "10545:8545"
    environment:
      VALIDATOR_L1_ETH_RPC: ws://l1:8546
      VALIDATOR_L2_ETH_RPC: http://l2:8545
      VALIDATOR_ROLLUP_RPC: http://kroma-node:8545
      VALIDATOR_CHALLENGER_POLL_INTERVAL: 1s
      VALIDATOR_OUTPUT_SUBMITTER_RETRY_INTERVAL: 1s
      VALIDATOR_OUTPUT_SUBMITTER_ROUND_BUFFER: 30
      VALIDATOR_NUM_CONFIRMATIONS: 1
      VALIDATOR_SAFE_ABORT_NONCE_TOO_LOW_COUNT: 3
      VALIDATOR_RESUBMISSION_TIMEOUT: 30s
      VALIDATOR_MNEMONIC: test test test test test test test test test test test junk
      VALIDATOR_HD_PATH: "m/44'/60'/0'/0/1"
      VALIDATOR_LOG_TERMINAL: "true"
      VALIDATOR_L2OO_ADDRESS: "${L2OO_ADDRESS}"
      VALIDATOR_COLOSSEUM_ADDRESS: "${COLOSSEUM_ADDRESS}"
      VALIDATOR_VALPOOL_ADDRESS: "${VALPOOL_ADDRESS}"
      VALIDATOR_PPROF_ENABLED: "true"
      VALIDATOR_METRICS_ENABLED: "true"
      VALIDATOR_ALLOW_NON_FINALIZED: "true"
      VALIDATOR_OUTPUT_SUBMITTER_ENABLED: "true"
      VALIDATOR_CHALLENGER_ENABLED: "false"
      VALIDATOR_SECURITYCOUNCIL_ADDRESS: "${SECURITYCOUNCIL_ADDRESS}"
      VALIDATOR_GUARDIAN_ENABLED: "false" # default to disabled
      VALIDATOR_TXMGR_TX_SEND_TIMEOUT: 600s
      VALIDATOR_RESUBSCRIBE_BACKOFF_MAX: 10s

  kroma-challenger:
    pid: host # allow debugging
    depends_on:
      - l1
      - l2
      - kroma-node
    build:
      context: ..
      target: "kroma-validator"
    environment:
      VALIDATOR_L1_ETH_RPC: ws://l1:8546
      VALIDATOR_L2_ETH_RPC: http://l2:8545
      VALIDATOR_ROLLUP_RPC: http://kroma-node:8545
      VALIDATOR_CHALLENGER_POLL_INTERVAL: 1s
      VALIDATOR_NUM_CONFIRMATIONS: 1
      VALIDATOR_SAFE_ABORT_NONCE_TOO_LOW_COUNT: 3
      VALIDATOR_RESUBMISSION_TIMEOUT: 30s
      VALIDATOR_MNEMONIC: test test test test test test test test test test test junk
      VALIDATOR_HD_PATH: "m/44'/60'/0'/0/11"
      VALIDATOR_LOG_TERMINAL: "true"
      VALIDATOR_L2OO_ADDRESS: "${L2OO_ADDRESS}"
      VALIDATOR_COLOSSEUM_ADDRESS: "${COLOSSEUM_ADDRESS}"
      VALIDATOR_VALPOOL_ADDRESS: "${VALPOOL_ADDRESS}"
      VALIDATOR_ALLOW_NON_FINALIZED: "true"
      VALIDATOR_PROVER_RPC: "0.0.0.0:0"
      VALIDATOR_OUTPUT_SUBMITTER_ENABLED: "false"
      VALIDATOR_CHALLENGER_ENABLED: "true"
      VALIDATOR_TXMGR_TX_SEND_TIMEOUT: 600s
      VALIDATOR_RESUBSCRIBE_BACKOFF_MAX: 10s

  kroma-batcher:
    pid: host # allow debugging
    depends_on:
      - l1
      - l2
      - kroma-node
    image: "kromanetwork/batcher"
    build:
      context: ..
      target: "op-batcher"
    ports:
      - "6061:6060"
      - "7301:7300"
    environment:
      BATCHER_L1_ETH_RPC: http://l1:8545
      BATCHER_L2_ETH_RPC: http://l2:8545
      BATCHER_ROLLUP_RPC: http://kroma-node:8545
      BATCHER_MAX_L1_TX_SIZE_BYTES: 120000
      BATCHER_TARGET_L1_TX_SIZE_BYTES: 624
      BATCHER_TARGET_NUM_FRAMES: 1
      BATCHER_APPROX_COMPR_RATIO: 1.0
      BATCHER_SUB_SAFETY_MARGIN: 6 # PWS is 15, ChannelTimeout is 40
      BATCHER_POLL_INTERVAL: 1s
      BATCHER_NUM_CONFIRMATIONS: 1
      BATCHER_SAFE_ABORT_NONCE_TOO_LOW_COUNT: 3
      BATCHER_RESUBMISSION_TIMEOUT: 30s
      BATCHER_MNEMONIC: test test test test test test test test test test test junk
      BATCHER_HD_PATH: "m/44'/60'/0'/0/2"
      BATCHER_LOG_TERMINAL: "true"
      BATCHER_PPROF_ENABLED: "true"
      BATCHER_METRICS_ENABLED: "true"
      BATCHER_TXMGR_TX_SEND_TIMEOUT: 600s

  stateviz:
    pid: host # allow debugging
    build:
      context: ..
      target: "op-stateviz"
    image: "kromanetwork/stateviz"
    command:
      - op-stateviz
      - -addr=0.0.0.0:8080
      - -snapshot=/kroma_log/snapshot.log
      - -refresh=10s
    ports:
      - "9090:8080"
    volumes:
      - kroma_log:/kroma_log:ro

  artifact-server:
    depends_on:
      - l1
    image: nginx:1.25-alpine
    ports:
      - "8080:80"
    volumes:
      - "${PWD}/../.devnet/:/usr/share/nginx/html/:ro"
    security_opt:
      - "no-new-privileges:true"
