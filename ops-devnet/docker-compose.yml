version: '3.4'

# This Compose file is expected to be used with the devnet-up.sh script.
# The volumes below mount the configs generated by the script into each
# service.

volumes:
  l1_data:
  l2_data:
  kroma_log:


services:
  create-beacon-chain-genesis:
    image: "gcr.io/prysmaticlabs/prysm/cmd/prysmctl:latest"
    command:
      - testnet
      - generate-genesis
      - --fork=deneb
      - --num-validators=1
      - --genesis-time-delay=15
      - --output-ssz=/gen/genesis-l1.ssz
      - --chain-config-file=/config.yml
      - --geth-genesis-json-in=/genesis.json
      - --geth-genesis-json-out=/genesis.json
    volumes:
      - "${PWD}/../.devnet/genesis-l1.json:/genesis.json"
      - "${PWD}/../.devnet:/gen"
      - "${PWD}/prysm-config.yml:/config.yml"

  beacon-chain:
    image: "gcr.io/prysmaticlabs/prysm/beacon-chain:latest"
    command:
      - --datadir=/db/beacondata
      - --min-sync-peers=0
      - --genesis-state=/genesis-l1.ssz
      - --interop-eth1data-votes
      - --bootstrap-node=
      - --chain-config-file=/config.yml
      - --rpc-host=0.0.0.0
      - --grpc-gateway-host=0.0.0.0
      - --execution-endpoint=http://l1:8551
      - --chain-id=900
      - --accept-terms-of-use
      - --jwt-secret=/test-jwt-secret.txt # consensus <> ex
      - --suggested-fee-recipient="0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"
      - --p2p-max-peers=0
      - --minimum-peers-per-subnet=0
      - --disable-monitoring
      - --pprof
      - --force-clear-db
      - --contract-deployment-block=0
    depends_on:
      create-beacon-chain-genesis:
        condition: service_completed_successfully
    ports:
      - "4000:4000"
      - "3500:3500"
      - "8080:8080"
    volumes:
      - "l1_data:/db"
      - "${PWD}/../.devnet/genesis-l1.ssz:/genesis-l1.ssz"
      - "${PWD}/prysm-config.yml:/config.yml"
      - "${PWD}/test-jwt-secret.txt:/test-jwt-secret.txt"

  validator:
    image: "gcr.io/prysmaticlabs/prysm/validator:latest"
    command:
      - --beacon-rpc-provider=beacon-chain:4000
      - --datadir=/db/validatordata
      - --accept-terms-of-use
      - --interop-num-validators=1
      - --interop-start-index=0
      - --chain-config-file=/config.yml
      - --config-file=/config.yml
      - --force-clear-db
      - --verbosity=trace
    depends_on:
      beacon-chain:
        condition: service_started
    volumes:
      - "l1_data:/db"
      - "${PWD}/prysm-config.yml:/config.yml"

  l1:
    image: "ethereum/client-go:latest"
    entrypoint: "/bin/sh /entrypoint.sh"
    ports:
      - "8551:8551"
      - "8545:8545" # rpc
      - "8546:8546" # wc
      - "6063:6060" # metric
      - "30303:30303" # p2p
    environment:
      CHAIN_ID: 900
      GETH_MINER_RECOMMIT: 100ms
    volumes:
      - "l1_data:/db"
      - "${PWD}/test-jwt-secret.txt:/config/jwt-secret.txt"
      - "${PWD}/../.devnet/genesis-l1.json:/genesis.json"
      - "${PWD}/entrypoint-l1.sh:/entrypoint.sh"
    depends_on:
      create-beacon-chain-genesis:
        condition: service_completed_successfully
      beacon-chain:
        condition: service_started

  l2:
    pid: host # allow debugging
    image: kromanetwork/geth:v0.5.0
    ports:
      - "9545:8545"
      - "9546:8546"
    environment:
      CHAIN_ID: 901
      GETH_MINER_RECOMMIT: 100ms
    volumes:
      - "l2_data:/db"
      - "${PWD}/entrypoint-l2.sh:/entrypoint.sh"
      - "${PWD}/../.devnet/genesis-l2.json:/genesis.json"
      - "${PWD}/test-jwt-secret.txt:/config/test-jwt-secret.txt"
    entrypoint: # pass the L2 specific flags by overriding the entry-point and adding extra arguments
      - "/bin/sh"
      - "/entrypoint.sh"
      - "--authrpc.jwtsecret=/config/test-jwt-secret.txt"

  kroma-node:
    pid: host # allow debugging
    depends_on:
      - l1
      - l2
    image: "kromanetwork/node"
    build:
      context: ..
      target: "op-node"
    environment:
      NODE_L1_ETH_RPC: ws://l1:8546
      NODE_L2_ENGINE_RPC: http://l2:8551
      NODE_L2_ENGINE_AUTH: /config/test-jwt-secret.txt
      NODE_ROLLUP_CONFIG: /rollup.json
      NODE_RPC_ADDR: 0.0.0.0
      NODE_RPC_PORT: 8545
      NODE_RPC_ENABLE_ADMIN: true
      NODE_L1_BEACON: http://beacon-chain:3500
      NODE_SNAPSHOT_LOG: /kroma_log/snapshot.log
      NODE_SEQUENCER_ENABLED: true
      NODE_SEQUENCER_L1_CONFS: 0
      NODE_VERIFIER_L1_CONFS: 0
      NODE_P2P_LISTEN_IP: 0.0.0.0
      NODE_P2P_LISTEN_TCP_PORT: 9003
      NODE_P2P_LISTEN_UDP_PORT: 9003
      NODE_P2P_PEER_SCORING: light
      NODE_P2P_PEER_BANNING: true
      NODE_P2P_PRIV_PATH: /config/p2p-node-key.txt
      NODE_P2P_SEQUENCER_KEY: 8b3a350cf5c34c9194ca85829a2df0ec3153be0318b5e2d3348e872092edffba
      NODE_METRICS_ENABLED: true
      NODE_METRICS_ADDR: 0.0.0.0
      NODE_METRICS_PORT: 7300
      NODE_PPROF_ENABLED: true
    ports:
      - "7545:8545"
      - "9003:9003"
      - "7300:7300"
      - "6060:6060"
    volumes:
      - "${PWD}/p2p-sequencer-key.txt:/config/p2p-sequencer-key.txt"
      - "${PWD}/p2p-node-key.txt:/config/p2p-node-key.txt"
      - "${PWD}/test-jwt-secret.txt:/config/test-jwt-secret.txt"
      - "${PWD}/../.devnet/rollup.json:/rollup.json"
      - kroma_log:/kroma_log

  kroma-validator:
    pid: host # allow debugging
    depends_on:
      - l1
      - l2
      - kroma-node
    image: "kromanetwork/validator"
    build:
      context: ..
      target: "kroma-validator"
    ports:
      - "6062:6060"
      - "7302:7300"
      - "10545:8545"
    environment:
      VALIDATOR_L1_ETH_RPC: ws://l1:8546
      VALIDATOR_L2_ETH_RPC: http://l2:8545
      VALIDATOR_ROLLUP_RPC: http://kroma-node:8545
      VALIDATOR_CHALLENGER_POLL_INTERVAL: 1s
      VALIDATOR_OUTPUT_SUBMITTER_RETRY_INTERVAL: 1s
      VALIDATOR_OUTPUT_SUBMITTER_ROUND_BUFFER: 30
      VALIDATOR_NUM_CONFIRMATIONS: 1
      VALIDATOR_SAFE_ABORT_NONCE_TOO_LOW_COUNT: 3
      VALIDATOR_RESUBMISSION_TIMEOUT: 30s
      VALIDATOR_MNEMONIC: test test test test test test test test test test test junk
      VALIDATOR_HD_PATH: "m/44'/60'/0'/0/1"
      VALIDATOR_L2OO_ADDRESS: "${L2OO_ADDRESS}"
      VALIDATOR_COLOSSEUM_ADDRESS: "${COLOSSEUM_ADDRESS}"
      VALIDATOR_VALPOOL_ADDRESS: "${VALPOOL_ADDRESS}"
      VALIDATOR_VALMANAGER_ADDRESS: "${VALMANAGER_ADDRESS}"
      VALIDATOR_ASSETMANAGER_ADDRESS: "${ASSETMANAGER_ADDRESS}"
      VALIDATOR_PPROF_ENABLED: "true"
      VALIDATOR_METRICS_ENABLED: "true"
      VALIDATOR_ALLOW_NON_FINALIZED: "true"
      VALIDATOR_OUTPUT_SUBMITTER_ENABLED: "true"
      VALIDATOR_CHALLENGER_ENABLED: "false"
      VALIDATOR_SECURITYCOUNCIL_ADDRESS: "${SECURITYCOUNCIL_ADDRESS}"
      VALIDATOR_GUARDIAN_ENABLED: "false" # default to disabled
      VALIDATOR_TXMGR_TX_SEND_TIMEOUT: 600s
      VALIDATOR_RESUBSCRIBE_BACKOFF_MAX: 10s

  kroma-challenger:
    pid: host # allow debugging
    depends_on:
      - l1
      - l2
      - kroma-node
    build:
      context: ..
      target: "kroma-validator"
    environment:
      VALIDATOR_L1_ETH_RPC: ws://l1:8546
      VALIDATOR_L2_ETH_RPC: http://l2:8545
      VALIDATOR_ROLLUP_RPC: http://kroma-node:8545
      VALIDATOR_CHALLENGER_POLL_INTERVAL: 1s
      VALIDATOR_NUM_CONFIRMATIONS: 1
      VALIDATOR_SAFE_ABORT_NONCE_TOO_LOW_COUNT: 3
      VALIDATOR_RESUBMISSION_TIMEOUT: 30s
      VALIDATOR_MNEMONIC: test test test test test test test test test test test junk
      VALIDATOR_HD_PATH: "m/44'/60'/0'/0/11"
      VALIDATOR_L2OO_ADDRESS: "${L2OO_ADDRESS}"
      VALIDATOR_COLOSSEUM_ADDRESS: "${COLOSSEUM_ADDRESS}"
      VALIDATOR_VALPOOL_ADDRESS: "${VALPOOL_ADDRESS}"
      VALIDATOR_ALLOW_NON_FINALIZED: "true"
      VALIDATOR_PROVER_RPC: "0.0.0.0:0"
      VALIDATOR_OUTPUT_SUBMITTER_ENABLED: "false"
      VALIDATOR_CHALLENGER_ENABLED: "true"
      VALIDATOR_TXMGR_TX_SEND_TIMEOUT: 600s
      VALIDATOR_RESUBSCRIBE_BACKOFF_MAX: 10s

  kroma-batcher:
    pid: host # allow debugging
    depends_on:
      - l1
      - l2
      - kroma-node
    image: "kromanetwork/batcher"
    build:
      context: ..
      target: "op-batcher"
    ports:
      - "6061:6060"
      - "7301:7300"
    environment:
      BATCHER_L1_ETH_RPC: http://l1:8545
      BATCHER_L2_ETH_RPC: http://l2:8545
      BATCHER_ROLLUP_RPC: http://kroma-node:8545
      BATCHER_MAX_L1_TX_SIZE_BYTES: 120000
      BATCHER_MAX_CHANNEL_DURATION: 20
      BATCHER_DATA_AVAILABILITY_TYPE: blobs
      BATCHER_BATCH_TYPE: 1 # 0 for SingularBatch and 1 for SpanBatch
      BATCHER_TARGET_NUM_FRAMES: 1
      BATCHER_APPROX_COMPR_RATIO: 1.0
      BATCHER_SUB_SAFETY_MARGIN: 6 # PWS is 15, ChannelTimeout is 40
      BATCHER_POLL_INTERVAL: 1s
      BATCHER_NUM_CONFIRMATIONS: 1
      BATCHER_SAFE_ABORT_NONCE_TOO_LOW_COUNT: 3
      BATCHER_RESUBMISSION_TIMEOUT: 30s
      BATCHER_MNEMONIC: test test test test test test test test test test test junk
      BATCHER_HD_PATH: "m/44'/60'/0'/0/2"
      BATCHER_PPROF_ENABLED: "true"
      BATCHER_METRICS_ENABLED: "true"
      BATCHER_TXMGR_TX_SEND_TIMEOUT: 600s

  stateviz:
    pid: host # allow debugging
    build:
      context: ..
      target: "op-stateviz"
    image: "kromanetwork/stateviz"
    command:
      - op-stateviz
      - -addr=0.0.0.0:8080
      - -snapshot=/kroma_log/snapshot.log
      - -refresh=10s
    ports:
      - "9090:8080"
    volumes:
      - kroma_log:/kroma_log:ro

  artifact-server:
    depends_on:
      - l1
    image: nginx:1.25-alpine
    ports:
      - "8081:80"
    volumes:
      - "${PWD}/../.devnet/:/usr/share/nginx/html/:ro"
    security_opt:
      - "no-new-privileges:true"
